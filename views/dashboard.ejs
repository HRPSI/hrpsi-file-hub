<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="navbar">
        <div class="left">
            <h6></h6>
        </div>
<!-- Wrap in a d-flex to align items horizontally; use spacing with ms-3 or me-3 as needed. -->
<div class="d-flex align-items-center">
    <a href="#" id="logoutButton" class="btn btn-danger">Logout</a>
</div>

    </div>
    <div class="filter-sort-container mb-3">
        <form method="GET" action="/files" class="d-flex align-items-center">
            <div class="me-2">
                <input 
                    type="text" 
                    class="form-control" 
                    name="search" 
                    placeholder="Search by name" 
                    value="<%= search %>"
                >
            </div>
            <div class="me-2">
                <select name="sort" class="form-select">
                    <option value="desc" <%= sort === 'desc' ? 'selected' : '' %>>Newest First</option>
                    <option value="asc" <%= sort === 'asc' ? 'selected' : '' %>>Oldest First</option>
                </select>
            </div>
            <div> <button type="submit" class="btn btn-primary">Apply</button></div>
           
            <div>
                   <!-- New: Reset button to clear filters by redirecting to /files with no query params -->
    <button 
    type="button" 
    class="btn btn-secondary ms-2"
    onclick="window.location='/files';"
  >
    Reset
  </button>
            </div>
        </form>
        <div class="me-3">
            <label for="file-upload" class="btn btn-success mb-0">
                Upload
            </label>
            <input 
                id="file-upload" 
                type="file" 
                name="files" 
                multiple
                class="d-none" 
                onchange="uploadFiles()"
            />
        </div>
    </div>
    
    <div id="dropZone" class="table-drop-zone table-responsive">
        <table class="table table-striped table-hover">
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Created/Modified At</th>
                    <!-- <th>Action</th> -->
                </tr>
            </thead>
            <tbody>
                <% if (files && files.length > 0) { %>
                    <% files.forEach(file => { %>
                        <tr>
                            <td>
                                <a href="/files/download/<%= encodeURIComponent(file.name) %>" class="text-decoration-none">
                                    <%= file.name %>
                                </a>
                            </td>
                            <td><%= new Date(file.lastModified).toLocaleString() %></td>
                            <!-- <td>
                                <a href="/files/download/<%= encodeURIComponent(file.name) %>" class="btn btn-primary btn-sm">
                                  Download
                                </a>
                                <a 
                                href="/files/delete/<%= encodeURIComponent(file.name) %>" 
                                class="btn btn-danger btn-sm"
                                onclick="return confirm('Are you sure you want to delete <%= file.name %>?');"
                              >
                                Delete
                              </a>
                              </td> -->
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr><td colspan="2" class="text-center">No files found</td></tr>
                <% } %>
            </tbody>
        </table>
    </div>
</table>
</div>

    

    <!-- Pagination -->
    <div class="pagination-tabs">
        <% for(let i = 1; i <= totalPages; i++) { %>
            <% if(i === currentPage) { %>
                <span class="tab active"><%= i %></span>
            <% } else { %>
                <a class="tab" href="/files?page=<%= i %>&search=<%= search %>&sort=<%= sort %>"><%= i %></a>
            <% } %>
        <% } %>
    </div>

    <div class="loader-overlay" id="loaderOverlay">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

    <script src="/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
      // Show loader on page load, hide once content is fully loaded
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('loaderOverlay').style.display = 'none';
      });

      // Handle file upload
      function uploadFiles() {
        const fileInput = document.getElementById('file-upload');
        const files = fileInput.files;
        const formData = new FormData();

            formData.append('file', files[0]);
        


        // Show loader
        document.getElementById('loaderOverlay').style.display = 'flex';

        const currentUser = localStorage.getItem('user');
        let token;
        if(!currentUser) {
            window.location.href = '/';
        } else {
            const user = JSON.parse(currentUser);   
            token = user.accessToken;
             }
        // Submit the form with the token
        fetch('https://api.hrpsi.com/api/v1/shared/upload-file', {
            method: 'POST',
            body: formData,
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('File upload result:', data);
            if(data.code === 401) {
                window.location.href = '/';
            }
            // Hide loader
            document.getElementById('loaderOverlay').style.display = 'none';
            // Optionally, handle the response (e.g., show a success message, refresh the file list, etc.)
        })
        .catch(error => {
            
            console.error('Error during file upload:', error);
            // Hide loader
            document.getElementById('loaderOverlay').style.display = 'none';
        });
    }

      // If you want to also show loader on filter/sort form submission:
      const filterForm = document.querySelector('form[method="GET"]');
      if (filterForm) {
        filterForm.addEventListener('submit', function() {
          document.getElementById('loaderOverlay').style.display = 'flex';
        });
      }

      // Read user's email from local storage and display it
      document.addEventListener('DOMContentLoaded', function() {
        const user = JSON.parse(localStorage.getItem('user'));
        if (user && user.email) {
            document.querySelector('.navbar .left h6').textContent = `Welcome, ${user.firstName} ${user.lastName}`;
        } else {
            window.location.href = '/';
        }
    });

    // Handle logout
    document.getElementById('logoutButton').addEventListener('click', function() {
        localStorage.removeItem('user');
        window.location.href = '/';
    });
    </script>
</body>
</html>
